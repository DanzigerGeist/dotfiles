{{- $destPath := joinPath .chezmoi.homeDir ".gc/config.toml" -}}
{{- $existing := dict -}}
{{- if (stat $destPath) -}}
  {{- $raw := output "cat" $destPath -}}
  {{- if ne (trim $raw) "" -}}
    {{- $existing = fromToml $raw -}}
  {{- end -}}
{{- end -}}
{{- $accountBases := dict -}}
{{- $entries := splitList "\n" (output "gopass" "ls" "--flat" "-d") -}}
{{- range $entry := $entries -}}
  {{- $entry = trimSuffix "/" $entry -}}
  {{- if and $entry (contains "/genesys/" $entry) -}}
    {{- $parts := splitList "/" $entry -}}
    {{- if and (eq (len $parts) 3) (eq (index $parts 1) "genesys") -}}
      {{- $prefix := index $parts 0 -}}
      {{- $name := index $parts 2 -}}
      {{- $_ := set $accountBases $name (printf "%s/genesys/%s" $prefix $name) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- range $name := sortAlpha (keys $accountBases) -}}
{{- $base := index $accountBases $name -}}
{{- $section := dict -}}
{{- if hasKey $existing $name -}}
  {{- $existingSection := index $existing $name -}}
  {{- range $k, $v := $existingSection -}}
    {{- $_ := set $section $k $v -}}
  {{- end -}}
{{- end -}}
{{- $_ := set $section "client_credentials" (trim (gopass (printf "%s/client/id" $base))) -}}
{{- $_ := set $section "client_secret" (trim (gopass (printf "%s/client/secret" $base))) -}}
{{- $_ := set $section "environment" (trim (gopass (printf "%s/environment" $base))) -}}
[{{ $name }}]
{{ toToml $section }}
{{- end -}}
